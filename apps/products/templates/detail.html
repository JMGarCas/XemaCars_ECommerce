{% extends 'base.html'%}
{% load static %}

{% block title %}Login{% endblock %}

{% block extrahead %}
<link rel="stylesheet" href="{% static "base.css" %}">
<link rel="stylesheet" href="{% static "details.css" %}">
{% endblock %}

{% block content %}
    <h2>Detalles del producto</h2>  
    <section class="product-card">
        <div class="product-details">
            <div class="detail-image">
                <img class="car-img" src="{{ product.image_url }}" alt="{{ product.name }}">
            </div>
            <div class="detail-info">
                <h2>{{ product.name }}</h2>
                <div class="brand-year">
                    <h4 class="product-brand">{{ product.brand }}</h4>
                    <h4> - </h4>
                    <h4 class="product-year">{{ product.year }}</h4>
                </div>
                <div class="combustion">
                    <h4 class="product-combustion">{{ product.combustion_type }}</h4>
                </div>
                <p>{{ product.description }}</p>
                <h2 class="product-price">{{ product.price }} €</h2>
                <a id="buy-btn" class="primary-button" >Comprar</a>
            </div>
        </div>
    </section>
    <div class="modal">
        <div class="modal-content form card-container">
            <h2>Elige un rango de fecha</h2>
            <span class="close material-icons">close</span>
            <article "form-field">
                <label>Desde:</label>
                <input id="from-date" type="date" min="${minDate}" max="${maxDate}"/>
            </article>
            <article "form-field">
                <label>Hasta:</label>
                <input id="to-date" type="date" disabled/>
            </article>
            <p id="error-msg"></p>
            <a id="confirm-btn" class="primary-button">Confirmar</a>
        </div>
    </div>
{% endblock %}


<script>
    {% block extrajs %}
        document.addEventListener('DOMContentLoaded', () => {
            const buyButton = document.querySelector('#buy-btn');
            buyButton.addEventListener('click', () => {
                spawnBuyModal();
            });
        });
        
        function validateDate(date, disabled_dates) {
            const to_date_input = document.querySelector('#to-date');
            const error_msg = document.querySelector('#error-msg');

            if (disabled_dates.includes(date)) {
                error_msg.innerHTML = 'La fecha seleccionada no está disponible';
                to_date_input.disabled = true;
                return false;
            }

            const from_date = new Date(date);
            /* get closest date to from_date that is bigger than from_date */
            tmp_disabled_dates = disabled_dates.filter(d => new Date(d) > from_date);
            tmp_disabled_dates.sort((a, b) => new Date(a) - new Date(b));
            let to_date = new Date(tmp_disabled_dates[0]);
            to_date.setDate(to_date.getDate() - 1);
            
            to_date_input.disabled = false;
            to_date_input.min = date;
            to_date_input.max = to_date.toISOString().slice(0, 10);

            return true;
        }

        function getDisabledDates() {
            return fetch("/products/disabled_dates/{{ product.id }}")
                .then(response => response.json())
                .then(data => {
                    const disabled_dates = [];
                    dates = data.disabled_dates;
                    dates.forEach(date => {
                        start_date = new Date(date.start);
                        end_date = new Date(date.end);
                        tmp_date = new Date(start_date);
                        while (tmp_date <= end_date) {
                            disabled_dates.push(tmp_date.toISOString().slice(0, 10));
                            tmp_date.setDate(tmp_date.getDate() + 1);
                        }
                    });
                    return disabled_dates;
                })
        }

        function addProductToCart(from_date, to_date) {
            const product_id = {{ product.id }};
            fetch("/cart/add", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    'product_id': product_id,
                    'from_date': from_date,
                    'to_date': to_date
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    const error_msg = document.querySelector('#error-msg');
                    error_msg.innerHTML = data.error;
                } else {
                    getCartCount();
                    closeModal();
                    showNotification('Producto añadido al carrito', 'success');
                }
            });
        }

        function closeModal() {
            const modal = document.querySelector('.modal');
            modal.style.display = 'none';
        }

        function spawnBuyModal() {
            getDisabledDates().then(disabled_dates => {
                const modal = document.querySelector('.modal');

                /* minDate is today */
                const today = new Date();
                const minDate = today.toISOString().slice(0, 10);
                const maxDate = new Date(today.getFullYear() + 1, today.getMonth(), today.getDate()).toISOString().slice(0, 10);

                modal.style.display = 'flex';
                const close = modal.querySelector('.close');
                close.addEventListener('click', () => {
                    modal.style.display = 'none';
                });

                document.querySelector('#from-date').onchange = evt => {
                    if(!validateDate(evt.target.value, disabled_dates)) {
                        evt.target.value = '';
                    }
                }

                document.querySelector('#confirm-btn').addEventListener('click', () => {
                    const from_date = document.querySelector('#from-date').value;
                    const to_date = document.querySelector('#to-date').value;
                    if (from_date && to_date) {
                        addProductToCart(from_date, to_date);
                    }
                });
            });
        }
    {% endblock %}
</script>
